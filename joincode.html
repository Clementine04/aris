<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Keyboard Warrior - Join Code</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="public/js/socket-client.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 'neon-cyan': '#00ffcc', 'neon-pink': '#ff33cc', 'neon-yellow': '#ffcc00' }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <style>
        /* --- COPY STYLES FROM DASHBOARD.HTML HERE FOR CONSISTENCY --- */
        /* Global + Background */
        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* Background Video */
        #bg-video {
            position: fixed;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translate(-50%, -50%);
            z-index: -1;
            object-fit: cover;
            opacity: 0.6;
        }

        #matrix-container {
            display: none;
        }

        .particle {
            display: none;
        }

        .square {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            transition: all .3s ease;
        }

        /* Logo */
        .logo-view-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            z-index: 10;
            position: relative;
            margin-top: -50px;
        }

        /* School Logos */
        .school-logos {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .school-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 8px;
        }

        @media (max-width: 640px) {
            .school-logo {
                width: 45px;
                height: 45px;
            }

            .school-logos {
                gap: 1rem;
                margin-bottom: 0.75rem;
            }
        }

        .text-row {
            display: flex;
            gap: .75rem;
            margin-bottom: .75rem;
            justify-content: center;
        }

        .letter-box {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 4rem;
            height: 4rem;
            font-size: 2rem;
            font-weight: 900;
            background-color: #000;
            border: 2px solid currentColor;
            border-radius: 6px;
            text-shadow: 0 0 8px rgba(255, 255, 255, .8), 0 0 5px currentColor;
            transition: all .4s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
            animation: subtle-pulse 2s infinite alternate ease-in-out;
        }

        @keyframes subtle-pulse {
            0% {
                box-shadow: 0 0 5px currentColor, 0 0 10px currentColor;
                transform: scale(1);
            }

            100% {
                box-shadow: 0 0 10px currentColor, 0 0 15px currentColor;
                transform: scale(1.01);
            }
        }

        .keyboard-letter {
            color: #00ffcc;
            border-color: #00ffcc;
        }

        .warrior-letter {
            color: #ff33cc;
            border-color: #ff33cc;
        }

        .letter-box:hover,
        .letter-box.active-glow {
            box-shadow: inset 0 0 20px currentColor, 0 0 15px currentColor, 0 0 25px currentColor;
            transform: scale(1.05);
            animation: none;
        }

        /* --- BUTTON STYLES (Copied/Adapted) --- */
        .buttons-column {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
            width: 100%;
            margin-top: 2.5rem;
        }

        .action-btn {
            padding: .75rem 2rem;
            font-size: 1.25rem;
            font-weight: 900;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            color: var(--button-color);
            border: 2px solid var(--button-color);
            background: #000;
            transition: all .25s ease;
            z-index: 10;
            position: relative;
            box-shadow: 0 0 5px rgba(0, 255, 204, .06);
            width: 260px;
            text-align: center;
        }

        .action-btn:hover {
            box-shadow: 0 0 10px var(--button-color), 0 0 15px var(--button-color);
            transform: scale(1.03);
        }

        /* Style for the slim back button */
        .slim-action-btn {
            padding: .5rem 1.5rem;
            /* Mas maliit na padding */
            font-size: 1rem;
            /* Mas maliit na font */
            width: 180px;
            /* Mas slim na lapad */
        }

        .btn-logout {
            --button-color: #333;
            color: #333;
            border-color: #333;
            background: transparent;
            font-size: 1rem;
            margin-top: 1.5rem;
            width: 150px;
            box-shadow: none;
        }

        .btn-logout:hover {
            color: #fff;
            border-color: #fff;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.4);
            transform: scale(1.03);
        }

        /* CODE INPUT SPECIFIC STYLE */
        .code-box {
            width: 45px;
            height: 60px;
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            border: 2px solid #ffcc00;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.8);
            color: #ffcc00;
            outline: none;
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
            transition: box-shadow 0.2s, border-color 0.2s;
            text-transform: uppercase;
            /* Ensure input is uppercase */
        }

        .code-box:focus {
            border-color: #ff33cc;
            box-shadow: 0 0 15px #ff33cc;
        }

        /* Notifier/Message Box Style */
        #status-message {
            min-height: 24px;
            /* Ensure space is reserved */
            font-weight: bold;
            transition: opacity 0.5s;
        }

        @media (max-width:640px) {
            .letter-box {
                width: 3rem;
                height: 3rem;
                font-size: 1.5rem;
                border-radius: 4px;
            }

            .text-row {
                gap: .5rem;
                margin-bottom: .5rem;
            }

            .logo-view-wrapper {
                margin-top: -30px;
            }

            .action-btn {
                padding: .6rem 1.25rem;
                font-size: 1rem;
                width: 200px;
            }

            .slim-action-btn {
                padding: .4rem 1rem;
                font-size: 0.9rem;
                width: 140px;
            }

            .btn-logout {
                width: 120px;
            }

            .code-box {
                width: 40px;
                height: 50px;
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>
    <!-- Background Video -->
    <video id="bg-video" autoplay muted loop playsinline>
        <source src="public/Media/bg-video.mp4" type="video/mp4">
    </video>

    <div id="matrix-container"></div>
    <audio id="background-music" loop>
        <source src="backgroundmusic.mp3" type="audio/mpeg">
    </audio>
    <div id="logo-view" class="logo-view-wrapper">
        <!-- School Logos -->
        <div class="school-logos">
            <img src="public/Media/Images/Logo-isu.png" alt="ISU" class="school-logo">
            <img src="public/Media/Images/logo ccsict.jpg" alt="CCSICT" class="school-logo">
        </div>
        <div class="logo-text-area">
            <div id="keyboard-row" class="text-row"></div>
            <div id="warrior-row" class="text-row"></div>
        </div>

        <div class="flex flex-col items-center p-6 border-2 border-neon-yellow rounded-xl shadow-neon-yellow"
            style="background:rgba(0,0,0,0.7); max-width:550px; width:90%; box-shadow:0 0 20px #ffcc00;">
            <p class="text-xl text-gray-300 mb-4">Input the Code:</p>

            <div id="code-input-container" class="flex gap-2 mb-6">
                <input type="text" class="code-box" maxlength="1" id="code-1">
                <input type="text" class="code-box" maxlength="1" id="code-2">
                <input type="text" class="code-box" maxlength="1" id="code-3">
                <input type="text" class="code-box" maxlength="1" id="code-4">
                <input type="text" class="code-box" maxlength="1" id="code-5">
                <input type="text" class="code-box" maxlength="1" id="code-6">
            </div>

            <div id="status-message" class="text-neon-pink text-center mb-4"></div>

            <button id="joinBtn" class="action-btn" style="--button-color: #ffcc00;" onclick="joinMatch()">
                <i class="fas fa-handshake mr-2"></i> Join Match
            </button>

            <button class="action-btn mt-4 slim-action-btn" style="--button-color: #ff33cc;"
                onclick="window.location.href='multiplayer.html'">
                <i class="fas fa-arrow-left mr-2"></i> Back
            </button>
        </div>
    </div>

    <script>
        // --- MUSIC INITIALIZATION ---
        const MUSIC_PREF_KEY = 'kw_music_enabled';

        function initializeMusic() {
            const audio = document.getElementById('background-music');
            const musicEnabled = localStorage.getItem(MUSIC_PREF_KEY) !== 'false';

            if (audio) {
                if (musicEnabled) {
                    audio.play().catch(e => { });
                } else {
                    audio.pause();
                    audio.currentTime = 0;
                }
            }
        }

        // Kailangan ito para ma-bypass ang browser autoplay restrictions
        document.addEventListener('click', () => {
            const audio = document.getElementById('background-music');
            const musicEnabled = localStorage.getItem(MUSIC_PREF_KEY) !== 'false';
            if (audio && audio.paused && musicEnabled) {
                audio.play().catch(e => { });
            }
        }, { once: true });
        // --- END MUSIC INITIALIZATION --- 

        // --- Particle and Logo Animation Logic (Copied from dashboard.html) ---
        const container = document.getElementById('matrix-container');
        const particles = [];
        const PARTICLE_COUNT = 100;
        const LETTERS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const FALL_SPEED_BASE = 0.05;
        const REPEL_RADIUS = 180;
        const REPEL_STRENGTH = 0.8;
        const DAMPING_FACTOR = 0.98;
        const GLOW_COLORS = [
            { background: 'rgba(0,255,240,0.2)', shadow: '0 0 10px rgba(0,255,240,0.6)' },
            { background: 'rgba(255,0,255,0.2)', shadow: '0 0 10px rgba(255,0,255,0.6)' },
            { background: 'rgba(0,255,128,0.2)', shadow: '0 0 10px rgba(0,255,128,0.6)' },
            { background: 'rgba(255,215,0,0.2)', shadow: '0 0 10px rgba(255,215,0,0.6)' },
            { background: 'rgba(200,150,255,0.2)', shadow: '0 0 10px rgba(200,150,255,0.6)' },
        ];
        let mousePos = { x: -1000, y: -1000 };
        let interactiveElements = [];
        class Particle {
            constructor(x, y, letter) {
                this.x = x; this.y = y; this.vx = 0; this.vy = FALL_SPEED_BASE; this.letter = letter;
                this.colorScheme = GLOW_COLORS[Math.floor(Math.random() * GLOW_COLORS.length)];
                this.element = document.createElement('div');
                this.element.className = 'particle';
                this.element.innerHTML = `<div class="square">${letter}</div>`;
                container.appendChild(this.element);
                const square = this.element.querySelector('.square');
                square.style.backgroundColor = this.colorScheme.background;
                square.style.boxShadow = this.colorScheme.shadow;
                square.style.color = '#000';
                this.updateDOM();
            }
            updateDOM() { this.element.style.transform = `translate3d(${this.x}px, ${this.y}px, 0)`; }
            update(deltaTime, width, height) {
                const dx = this.x - mousePos.x, dy = this.y - mousePos.y;
                const distanceSq = dx * dx + dy * dy;
                if (distanceSq < REPEL_RADIUS * REPEL_RADIUS) {
                    const distance = Math.sqrt(distanceSq) || 1;
                    const force = (REPEL_RADIUS - distance) / REPEL_RADIUS * REPEL_STRENGTH;
                    this.vx += dx / distance * force; this.vy += dy / distance * force;
                }
                this.vy += FALL_SPEED_BASE * 0.1;
                this.vx *= DAMPING_FACTOR; this.vy *= DAMPING_FACTOR;
                this.x += this.vx * deltaTime; this.y += this.vy * deltaTime;
                if (this.y > height + 50) {
                    this.y = -50; this.x = Math.random() * width;
                    this.letter = LETTERS[Math.floor(Math.random() * LETTERS.length)];
                    this.colorScheme = GLOW_COLORS[Math.floor(Math.random() * GLOW_COLORS.length)];
                    const square = this.element.querySelector('.square');
                    square.textContent = this.letter;
                    square.style.backgroundColor = this.colorScheme.background;
                    square.style.boxShadow = this.colorScheme.shadow;
                    square.style.color = '#000';
                    this.vy = FALL_SPEED_BASE;
                }
                if (this.x < -50) this.x = width + 50;
                if (this.x > width + 50) this.x = -50;
                this.updateDOM();
            }
        }
        const renderLetters = (word, id, className) => {
            const el = document.getElementById(id);
            if (!el || el.children.length > 0) return;
            word.toUpperCase().split('').forEach(ch => {
                const box = document.createElement('div');
                box.textContent = ch;
                box.classList.add('letter-box', className);
                el.appendChild(box);
            });
        };
        let lastTime = 0;
        function animate(time) {
            if (!lastTime) lastTime = time;
            const deltaTime = (time - lastTime) / 16.666; lastTime = time;
            const width = window.innerWidth, height = window.innerHeight;
            particles.forEach(p => p.update(deltaTime, width, height));
            requestAnimationFrame(animate);
        }
        function updateGlow(x, y) {
            const isTouch = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
            const hitboxExpansion = isTouch ? 25 : 0;
            interactiveElements.forEach(el => {
                const rect = el.getBoundingClientRect();
                const isOver = x >= rect.left - hitboxExpansion && x <= rect.right + hitboxExpansion &&
                    y >= rect.top - hitboxExpansion && y <= rect.bottom + hitboxExpansion;
                if (isOver) { if (isTouch || !el.matches(':hover')) el.classList.add('active-glow'); }
                else el.classList.remove('active-glow');
            });
        }
        function handleMouseMove(e) { mousePos = { x: e.clientX, y: e.clientY }; updateGlow(e.clientX, e.clientY); }
        function handleTouchMove(e) { if (e.touches.length > 0) { e.preventDefault(); const t = e.touches[0]; mousePos = { x: t.clientX, y: t.clientY }; updateGlow(t.clientX, t.clientY); } }
        function handleTouchEnd() { mousePos = { x: -1000, y: -1000 }; interactiveElements.forEach(el => el.classList.remove('active-glow')); }
        function handleResize() { clearTimeout(window.__resizeT); window.__resizeT = setTimeout(() => initializeBackground(), 250); }
        let animationStarted = false;
        function initializeBackground() {
            renderLetters('KEYBOARD', 'keyboard-row', 'keyboard-letter');
            renderLetters('WARRIOR', 'warrior-row', 'warrior-letter');
            const keyboardLetters = document.querySelectorAll('#keyboard-row .letter-box');
            const warriorLetters = document.querySelectorAll('#warrior-row .letter-box');

            interactiveElements = [...keyboardLetters, ...warriorLetters,
            document.getElementById('joinBtn'),
            document.querySelector('.action-btn.slim-action-btn') // Updated selector for the Back button
            ];

            particles.forEach(p => p.element.remove());
            particles.length = 0;
            // Particles disabled for performance
            // const width = window.innerWidth, height=window.innerHeight;
            // for(let i=0;i<PARTICLE_COUNT;i++){
            //     particles.push(new Particle(Math.random()*width, Math.random()*height, LETTERS[Math.floor(Math.random()*LETTERS.length)]));
            // }
            // if(!animationStarted){ requestAnimationFrame(animate); animationStarted=true; }
            // Removed force music play here
            setupCodeInputLogic(); // Setup input handling
            checkInitialCode(); // Check for code in URL
        }
        window.addEventListener('mousemove', handleMouseMove);
        window.addEventListener('touchmove', handleTouchMove, { passive: false });
        window.addEventListener('touchend', handleTouchEnd);
        window.addEventListener('load', () => {
            initializeBackground();
            initializeMusic();

            // Connect to Socket.IO
            if (!socketManager.connected) {
                socketManager.connect();
            }

            const username = sessionStorage.getItem('kw_current_user');
            if (username) {
                socketManager.authenticate(username);
            }
        });
        window.addEventListener('resize', handleResize);
        // --- END Particle and Logo Animation Logic ---


        const inputs = Array.from(document.querySelectorAll('.code-box'));
        const statusMessage = document.getElementById('status-message');
        const joinButton = document.getElementById('joinBtn');
        const MAX_PLAYERS = 2;
        let playerCheckInterval;

        function setupCodeInputLogic() {
            // Logic for auto-focusing and capitalizing input
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    const value = e.target.value.toUpperCase();
                    e.target.value = value;
                    if (value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                    if (getAllCode().length === 6) {
                        // Once code is complete, try to join automatically or enable button
                        joinButton.disabled = false;
                    } else {
                        joinButton.disabled = true;
                        // Reset status if code is incomplete
                        statusMessage.innerHTML = '';
                        clearInterval(playerCheckInterval);
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && input.value.length === 0 && index > 0) {
                        inputs[index - 1].focus();
                    }
                });
            });
            joinButton.disabled = true; // Disable button initially
        }

        function getAllCode() {
            return inputs.map(input => input.value).join('');
        }

        function checkInitialCode() {
            // Kunin ang code mula sa URL (kung galing sa createcode.html)
            const urlParams = new URLSearchParams(window.location.search);
            const initialCode = urlParams.get('code');

            if (initialCode && initialCode.length === 6) {
                // I-populate ang input fields
                initialCode.split('').forEach((char, index) => {
                    if (inputs[index]) {
                        inputs[index].value = char.toUpperCase();
                    }
                });
                joinButton.disabled = false;
                // Simulan agad ang join process
                joinMatch();
            }
        }

        function joinMatch() {
            const code = getAllCode();
            const username = sessionStorage.getItem('kw_current_user');

            if (!username) {
                statusMessage.textContent = 'Please login first!';
                statusMessage.style.color = '#ff33cc';
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
                return;
            }

            if (code.length !== 6) {
                statusMessage.textContent = 'Please enter a complete 6-digit code!';
                statusMessage.style.color = '#ff33cc';
                return;
            }

            // Disable input and button while joining
            inputs.forEach(input => input.disabled = true);
            joinButton.disabled = true;
            joinButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Joining Room...';
            statusMessage.style.color = '#ffcc00';
            statusMessage.textContent = `Connecting to room ${code}...`;

            // Connect to socket if not connected
            if (!socketManager.connected) {
                socketManager.connect();
            }

            // Join room using Socket.IO
            socketManager.joinRoom(code, username, (error, data) => {
                if (error) {
                    statusMessage.textContent = error.message || 'Failed to join room. Code may be invalid.';
                    statusMessage.style.color = '#ff33cc';
                    inputs.forEach(input => input.disabled = false);
                    joinButton.disabled = false;
                    joinButton.innerHTML = '<i class="fas fa-handshake mr-2"></i> Join Match';
                    return;
                }

                // Successfully joined
                statusMessage.textContent = `Joined! Waiting for players... (${data.playerCount}/${MAX_PLAYERS})`;
                statusMessage.style.color = '#00ffcc';

                // Store room code
                sessionStorage.setItem('kw_current_room', code);

                // Listen for player updates
                socketManager.onPlayerJoined((updateData) => {
                    statusMessage.textContent = `Players: ${updateData.playerCount}/${MAX_PLAYERS}. Waiting...`;

                    if (updateData.isFull) {
                        statusMessage.textContent = 'Room full! Redirecting to game...';
                        joinButton.innerHTML = '<i class="fas fa-check-circle mr-2"></i> STARTING...';
                        setTimeout(() => {
                            window.location.href = `keyboardwarriorgame.html?mode=multiplayer&room=${code}`;
                        }, 1000);
                    }
                });

                // When room is full, redirect to game page
                if (data.isFull) {
                    statusMessage.textContent = 'Room full! Redirecting to game...';
                    joinButton.innerHTML = '<i class="fas fa-check-circle mr-2"></i> STARTING...';
                    setTimeout(() => {
                        window.location.href = `keyboardwarriorgame.html?mode=multiplayer&room=${code}`;
                    }, 1000);
                }
            });
        }

        // Clean up when leaving page
        window.addEventListener('beforeunload', () => {
            clearInterval(playerCheckInterval);
            const roomCode = sessionStorage.getItem('kw_current_room');
            if (roomCode && socketManager.connected) {
                socketManager.leaveRoom(roomCode);
            }
        });

    </script>
</body>

</html>